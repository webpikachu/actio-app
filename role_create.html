<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Создать роль</title>

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#0d7ff2",
            bgLight: "#f5f7f8",
            bgDark: "#101922",
            surfaceDark: "#182634",
            borderDark: "#314d68",
            textMuted: "#90adcb",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
        },
      },
    };
  </script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { scrollbar-width: none; }
  </style>
</head>

<body class="bg-bgLight dark:bg-bgDark text-gray-900 dark:text-white h-screen overflow-hidden">

<div class="relative flex flex-col h-full max-w-md mx-auto">

  <!-- HEADER -->
  <header class="sticky top-0 z-20 flex items-center gap-3 px-4 py-3 bg-bgLight/95 dark:bg-bgDark/95 backdrop-blur border-b border-gray-200 dark:border-borderDark">
    <button onclick="goBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-surfaceDark">
      <span class="material-symbols-outlined">arrow_back_ios_new</span>
    </button>
    <h1 class="flex-1 text-center font-semibold truncate pr-6">
      Создать роль
    </h1>
  </header>

  <!-- CONTENT -->
  <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-32 space-y-6">

    <!-- ROLE NAME -->
    <section class="space-y-2">
      <label class="text-xs uppercase text-gray-500 dark:text-textMuted font-semibold ml-1">
        Название роли
      </label>
      <input
        id="role-name"
        type="text"
        placeholder="Например: Python Senior Developer"
        class="w-full h-14 px-4 rounded-xl border border-gray-200 dark:border-borderDark bg-white dark:bg-surfaceDark focus:outline-none focus:ring-2 focus:ring-primary text-base"
      />
      <p class="text-xs text-gray-400 ml-1">
        Краткое и точное позиционирование под рынок.
      </p>
    </section>

    <!-- SKILLS -->
    <section class="space-y-3">
      <div class="flex items-center justify-between ml-1">
        <label class="text-xs uppercase text-gray-500 dark:text-textMuted font-semibold">
          Навыки
        </label>
        <button onclick="clearSkills()" class="text-xs text-primary hover:underline">
          Очистить
        </button>
      </div>

      <div id="skills-list" class="flex flex-wrap gap-2"></div>

      <div class="flex rounded-xl overflow-hidden border border-gray-200 dark:border-borderDark">
        <input
          id="skill-input"
          type="text"
          placeholder="Добавить навык и нажать Enter"
          class="flex-1 h-12 px-4 bg-white dark:bg-surfaceDark focus:outline-none text-sm"
          onkeydown="handleSkillInput(event)"
        />
        <button
          onclick="addSkill()"
          class="px-4 bg-gray-100 dark:bg-surfaceDark hover:bg-gray-200 dark:hover:bg-borderDark transition"
        >
          <span class="material-symbols-outlined">add</span>
        </button>
      </div>
    </section>

    <!-- EXPERIENCE -->
    <section class="space-y-2">
      <label class="text-xs uppercase text-gray-500 dark:text-textMuted font-semibold ml-1">
        Опыт
      </label>
      <textarea
        id="experience"
        rows="6"
        placeholder="Кратко опишите ваш опыт, ключевые проекты и достижения…"
        class="w-full p-4 rounded-xl border border-gray-200 dark:border-borderDark bg-white dark:bg-surfaceDark focus:outline-none focus:ring-2 focus:ring-primary resize-none text-base"
      ></textarea>
    </section>

  </main>

  <!-- FOOTER -->
  <footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto p-4 pb-8 bg-bgLight/90 dark:bg-bgDark/90 backdrop-blur border-t border-gray-200 dark:border-borderDark">
    <button
      onclick="saveRole()"
      class="w-full h-14 bg-primary hover:bg-blue-600 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 active:scale-[0.98] transition flex items-center justify-center gap-2"
    >
      <span class="material-symbols-outlined">save</span>
      Сохранить роль
    </button>
  </footer>

</div>

<!-- ================= LOGIC ================= -->
<script>
const tg = window.Telegram.WebApp;
tg.expand();

const SUPABASE_URL = "https://ТВОЙ.supabase.co";
const SUPABASE_KEY = "ТВОЙ_PUBLIC_ANON_KEY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const currentUserId = tg.initDataUnsafe?.user?.id;
const returnTo = new URLSearchParams(window.location.search).get("return_to");

const skills = [];
const skillsList = document.getElementById("skills-list");

if (!currentUserId) {
  tg.showAlert("Ошибка авторизации");
  goBack();
}

/* ================= SKILLS ================= */
function handleSkillInput(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    addSkill();
  }
}

function addSkill() {
  const input = document.getElementById("skill-input");
  const value = input.value.trim();
  if (!value || skills.includes(value)) return;

  skills.push(value);
  input.value = "";
  renderSkills();
}

function removeSkill(skill) {
  const i = skills.indexOf(skill);
  if (i >= 0) skills.splice(i, 1);
  renderSkills();
}

function clearSkills() {
  skills.length = 0;
  renderSkills();
}

function renderSkills() {
  skillsList.innerHTML = skills
    .map(
      (s) => `
      <div class="flex items-center gap-1 px-3 py-1.5 rounded-lg bg-primary/10 text-primary text-sm cursor-pointer"
           onclick="removeSkill('${escapeHtml(s)}')">
        <span>${escapeHtml(s)}</span>
        <span class="material-symbols-outlined text-[16px]">close</span>
      </div>`
    )
    .join("");
}

/* ================= SAVE ================= */
async function saveRole() {
  const roleName = document.getElementById("role-name").value.trim();
  const experience = document.getElementById("experience").value.trim();

  if (!roleName) {
    tg.showAlert("Введите название роли");
    return;
  }

  const { error } = await supabaseClient
    .from("user_roles")
    .insert([{
      user_id: currentUserId,
      role_name: roleName,
      skills: skills,
      experience: experience
    }]);

  if (error) {
    tg.showAlert("Ошибка: " + error.message);
    return;
  }

  tg.showAlert("Роль сохранена");

  if (returnTo) {
    window.location.href = returnTo;
  } else {
    window.location.href = "roles.html";
  }
}

/* ================= HELPERS ================= */
function goBack() {
  if (returnTo) {
    window.location.href = returnTo;
  } else {
    window.location.href = "roles.html";
  }
}

function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, (m) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#039;",
  }[m]));
}
</script>

</body>
</html>
