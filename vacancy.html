<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Детали вакансии</title>

  <!-- Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#0d7ff2",
            bgLight: "#f5f7f8",
            bgDark: "#101c22",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
        },
      },
    };
  </script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { scrollbar-width: none; }
  </style>
</head>

<body class="bg-bgLight dark:bg-bgDark text-gray-900 dark:text-white h-screen overflow-hidden">

<div class="relative flex flex-col h-full max-w-md mx-auto">

  <!-- HEADER -->
  <header class="sticky top-0 z-20 flex items-center gap-3 px-4 py-3 bg-bgLight/95 dark:bg-bgDark/95 backdrop-blur border-b border-gray-200 dark:border-gray-800">
    <button onclick="goBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800">
      <span class="material-symbols-outlined">close</span>
    </button>
    <h1 class="flex-1 text-center font-semibold truncate pr-6">
      Детали вакансии
    </h1>
  </header>

  <!-- CONTENT -->
  <main id="vacancy-content" class="flex-1 overflow-y-auto no-scrollbar pb-28">

    <div class="px-4 py-10 text-center text-gray-400 animate-pulse">
      Загрузка вакансии…
    </div>

  </main>

  <!-- FOOTER -->
  <footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto p-4 pb-8 bg-bgLight/95 dark:bg-bgDark/95 backdrop-blur border-t border-gray-200 dark:border-gray-800">
    <button
      id="apply-btn"
      onclick="apply()"
      class="w-full bg-primary hover:bg-blue-600 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 active:scale-[0.98] transition"
    >
      Откликнуться
    </button>
  </footer>

</div>

<!-- ================= LOGIC ================= -->
<script>
/* ==============================
   INIT
================================ */
const tg = window.Telegram.WebApp;
tg.expand();

const SUPABASE_URL = "https://ТВОЙ.supabase.co";
const SUPABASE_KEY = "ТВОЙ_PUBLIC_ANON_KEY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const params = new URLSearchParams(window.location.search);
const vacancyId = params.get("id");

const container = document.getElementById("vacancy-content");
const applyBtn = document.getElementById("apply-btn");

let vacancy = null;

document.addEventListener("DOMContentLoaded", async () => {
  if (!vacancyId) {
    container.innerHTML = `<div class="p-6 text-center text-red-500">Вакансия не найдена</div>`;
    applyBtn.disabled = true;
    return;
  }

  await loadVacancy();
});

/* ==============================
   LOAD VACANCY
================================ */
async function loadVacancy() {
  const { data, error } = await supabaseClient
    .from("vacancies")
    .select("*")
    .eq("id", vacancyId)
    .single();

  if (error || !data) {
    container.innerHTML = `<div class="p-6 text-center text-red-500">Ошибка загрузки</div>`;
    applyBtn.disabled = true;
    return;
  }

  vacancy = data;
  renderVacancy();
}

/* ==============================
   RENDER
================================ */
function renderVacancy() {
  container.innerHTML = `
    <div class="px-4 pt-6 pb-2 text-center">
      <h2 class="text-2xl font-bold tracking-tight">${escapeHtml(vacancy.title)}</h2>
      <div class="mt-1 text-sm text-gray-500">
        ${escapeHtml(vacancy.city || "Удаленно")}
      </div>
    </div>

    <div class="px-4 py-4 flex flex-wrap justify-center gap-2">
      ${renderChip("payments", salaryText())}
      ${vacancy.level ? renderChip("school", vacancy.level) : ""}
      ${vacancy.format ? renderChip("public", vacancy.format) : ""}
    </div>

    <div class="h-px bg-gray-200 dark:bg-gray-800 my-2"></div>

    <div class="px-4 py-4 space-y-4">
      <h3 class="text-lg font-bold">Описание</h3>
      <p class="text-gray-600 dark:text-gray-300 whitespace-pre-line">
        ${escapeHtml(vacancy.description || "Описание не указано")}
      </p>
    </div>

    ${
      vacancy.tech_stack && vacancy.tech_stack.length
        ? `
    <div class="px-4 py-4">
      <h3 class="text-lg font-bold mb-2">Технологии</h3>
      <div class="flex flex-wrap gap-2">
        ${vacancy.tech_stack
          .map(
            (t) =>
              `<span class="px-2 py-1 rounded-md bg-primary/10 text-primary text-xs">${escapeHtml(t)}</span>`
          )
          .join("")}
      </div>
    </div>`
        : ""
    }

    <div class="h-6"></div>
  `;
}

/* ==============================
   APPLY
================================ */
function apply() {
  if (!vacancy) return;
  window.location.href = `roles.html?vacancy_id=${encodeURIComponent(vacancy.id)}`;
}

/* ==============================
   HELPERS
================================ */
function renderChip(icon, text) {
  return `
    <div class="flex items-center gap-1 px-3 py-1.5 rounded-lg bg-gray-200 dark:bg-gray-800 text-xs">
      <span class="material-symbols-outlined text-[16px]">${icon}</span>
      <span>${escapeHtml(text)}</span>
    </div>
  `;
}

function salaryText() {
  if (!vacancy.salary_min && !vacancy.salary_max) return "Зарплата не указана";
  if (vacancy.salary_min && vacancy.salary_max)
    return `${vacancy.salary_min}–${vacancy.salary_max} ${vacancy.currency || ""}`;
  return `${vacancy.salary_min || vacancy.salary_max} ${vacancy.currency || ""}`;
}

function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, (m) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#039;",
  }[m]));
}

function goBack() {
  window.location.href = "index.html";
}
</script>

</body>
</html>
