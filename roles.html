<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Выбор роли</title>

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
    rel="stylesheet"
  />

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#0d7ff2",
            bgDark: "#101922",
            surfaceDark: "#1c2630",
            borderDark: "#2a3b4d",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
        },
      },
    };
  </script>
</head>

<body class="bg-black font-display h-screen w-full overflow-hidden">

<!-- Dim background -->
<div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

<!-- Bottom sheet -->
<div class="absolute inset-x-0 bottom-0 flex justify-center z-20">
  <div class="w-full max-w-md bg-white dark:bg-bgDark rounded-t-2xl shadow-xl flex flex-col max-h-[90vh] animate-slide-up">

    <!-- Handle -->
    <div class="flex justify-center py-3">
      <div class="w-10 h-1.5 rounded-full bg-gray-300 dark:bg-borderDark"></div>
    </div>

    <!-- Header -->
    <div class="px-5 pb-4 flex items-center justify-between">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white">
        Выберите роль
      </h2>
      <button onclick="goBack()" class="text-gray-400 hover:text-gray-600">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto px-5 pb-4">
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
        Выберите профиль, который хотите использовать для этого отклика.
      </p>

      <!-- Roles list -->
      <div id="roles-list" class="flex flex-col gap-3"></div>

      <!-- Add role -->
      <button
        id="add-role-btn"
        class="mt-4 w-full flex items-center gap-2 py-2 text-primary hover:text-blue-400 transition"
      >
        <span class="material-symbols-outlined">add_circle</span>
        <span class="text-sm font-semibold">Добавить новую роль</span>
      </button>
    </div>

    <!-- Footer -->
    <div class="p-5 pt-3 border-t dark:border-white/5">
      <button
        id="confirm-btn"
        class="w-full h-12 rounded-xl bg-primary hover:bg-blue-600 active:scale-[0.98] transition text-white font-bold shadow-lg shadow-blue-500/20"
      >
        Подтвердить отклик
      </button>
    </div>

  </div>
</div>

<!-- Logic -->
<script>
/* ==============================
   CONFIG
================================ */
const tg = window.Telegram.WebApp;
tg.expand();

const SUPABASE_URL = "https://ТВОЙ.supabase.co";
const SUPABASE_KEY = "ТВОЙ_PUBLIC_ANON_KEY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const currentUserId = tg.initDataUnsafe?.user?.id;
const params = new URLSearchParams(window.location.search);
const vacancyId = params.get("vacancy_id");

const rolesList = document.getElementById("roles-list");
const confirmBtn = document.getElementById("confirm-btn");
const addRoleBtn = document.getElementById("add-role-btn");

let selectedRoleId = null;

/* ==============================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", async () => {
  if (!currentUserId || !vacancyId) {
    tg.showAlert("Ошибка контекста");
    goBack();
    return;
  }

  await loadRoles();
});

/* ==============================
   LOAD ROLES
================================ */
async function loadRoles() {
  const { data, error } = await supabaseClient
    .from("user_roles")
    .select("*")
    .eq("user_id", currentUserId)
    .order("created_at", { ascending: false });

  if (error) {
    rolesList.innerHTML = `<div class="text-red-500">Ошибка загрузки</div>`;
    return;
  }

  if (!data || data.length === 0) {
    rolesList.innerHTML = `
      <div class="p-4 rounded-xl bg-gray-100 dark:bg-surfaceDark text-gray-500 text-sm">
        У вас пока нет ролей. Создайте первую.
      </div>`;
    return;
  }

  selectedRoleId = data[0].id;

  rolesList.innerHTML = data
    .map((r, i) => renderRole(r, i === 0))
    .join("");

  document
    .querySelectorAll("input[name='role_select']")
    .forEach((input) => {
      input.addEventListener("change", () => {
        selectedRoleId = input.value;
      });
    });
}

/* ==============================
   RENDER ROLE
================================ */
function renderRole(role, selected) {
  const subtitle =
    role.skills && role.skills.length
      ? role.skills.slice(0, 3).join(" • ")
      : "Без навыков";

  return `
<label class="flex items-center justify-between p-4 rounded-xl border ${
    selected
      ? "border-primary bg-primary/5"
      : "border-gray-200 dark:border-borderDark bg-white dark:bg-surfaceDark"
  } cursor-pointer transition">
  <div>
    <div class="font-semibold text-gray-900 dark:text-white">
      ${escapeHtml(role.role_name)}
    </div>
    <div class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
      ${escapeHtml(subtitle)}
    </div>
  </div>
  <div class="relative">
    <input
      type="radio"
      name="role_select"
      value="${role.id}"
      class="sr-only peer"
      ${selected ? "checked" : ""}
    />
    <div class="w-6 h-6 rounded-full border-2 border-gray-300 dark:border-gray-500 peer-checked:bg-primary peer-checked:border-primary flex items-center justify-center">
      <span class="material-symbols-outlined text-white text-sm hidden peer-checked:block">
        check
      </span>
    </div>
  </div>
</label>`;
}

/* ==============================
   ACTIONS
================================ */
confirmBtn.addEventListener("click", () => {
  if (!selectedRoleId) {
    tg.showAlert("Выберите роль");
    return;
  }

  sessionStorage.setItem("selected_role_id", selectedRoleId);
  sessionStorage.setItem("selected_vacancy_id", vacancyId);
  window.location.href = "index.html";
});

addRoleBtn.addEventListener("click", () => {
  window.location.href =
    "role_create.html?return_to=" +
    encodeURIComponent(window.location.href);
});

function goBack() {
  window.location.href = "index.html";
}

/* ==============================
   HELPERS
================================ */
function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, (m) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#039;",
  }[m]));
}
</script>

<!-- Animation -->
<style>
@keyframes slide-up {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.animate-slide-up {
  animation: slide-up 0.25s cubic-bezier(0.16,1,0.3,1);
}
</style>

</body>
</html>
